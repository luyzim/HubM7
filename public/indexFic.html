<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Automação RoyalFic</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1749150270018-1dee5a5e4b88?q=80&w=1170&auto=format&fit=crop');
            background-size: cover; background-repeat: no-repeat; background-position: center; background-attachment: fixed;
            margin: 0; padding: 40px 20px; height: 100%;
        }
        .container {
            background-color: rgba(31, 41, 55, 0.9);
            padding: 30px; max-width: 600px; margin: auto; border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,.25); transition: box-shadow .3s ease;
        }
        .container:hover { box-shadow: 0 10px 15px rgba(0,0,0,.3); }
        h1 { text-align: center; color: #e5e7eb; font-weight: 600; margin-bottom: 24px; letter-spacing: 1px; }
        label { display: block; color: #d1d5db; margin-bottom: 8px; font-size: 14px; }
        input, select, button {
            width: 100%; padding: 12px; margin-bottom: 20px; font-size: 14px; border-radius: 8px;
            border: 1px solid #4b5563; background-color: #1f2937; color: #f3f4f6;
            transition: border-color .3s ease, box-shadow .3s ease;
        }
        input::placeholder { color: #1F2937; }
        input:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,.3); }
        button {
            background-color: #3b82f6; color: #fff; font-weight: 600; cursor: pointer; border: none; text-transform: uppercase;
            transition: background-color .3s ease, transform .2s ease-in-out;
        }
        button:hover { background-color: #2563eb; transform: translateY(-2px); }
        #resultado, #erro {
            padding: 15px; border-left-width: 5px; border-style: solid; margin-top: 20px; border-radius: 8px;
            white-space: pre-wrap; word-break: break-word; display: none;
        }
        #resultado { border-left-color: #22c55e; background-color: rgba(34,197,94,.1); color: #d1fae5; }
        #erro { border-left-color: #ef4444; background-color: rgba(239,68,68,.1); color: #fecaca; }
        @media (max-width: 600px) { body { padding: 20px 10px; } .container { padding: 20px; } }
    </style>
</head>
<body>
    <div class="container">
        <img src="https://i.ibb.co/xtJg72tV/EDCURuB.png" alt="Logo" style="display:block; margin: 0 auto; max-height: 100px;">
        <h1>Automação RoyalFic</h1>

        <label for="unidade">Escolha a unidade:</label>
        <input type="text" id="pesquisa" placeholder="Pesquisar unidade...">
        <select id="unidadeSelect" size="8" style="color: black;"></select>

        <button id="executarBtn">Executar Automação</button>

        <div id="resultado"></div>
        <div id="erro"></div>
    </div>

    <script>
        // refs
        let unidades = [];
        const unidadeSelect = document.getElementById('unidadeSelect');
        const pesquisa = document.getElementById('pesquisa');
        const resultadoDiv = document.getElementById('resultado');
        const erroDiv = document.getElementById('erro');
        const executarBtn = document.getElementById('executarBtn');

        // helpers UI
        function show(el, text) { el.textContent = text; el.style.display = 'block'; }
        function hide(...els) { els.forEach(e => e.style.display = 'none'); }
        function atualizarSelect(lista) {
            unidadeSelect.innerHTML = '';
            lista.forEach(u => {
                            const opt = document.createElement('option');
                            opt.value = u; opt.textContent = u; opt.style.color = "black";                unidadeSelect.appendChild(opt);
            });
        }

        // carregar lista de unidades (JSON envelope ou array “cru”)
        async function carregarUnidades() {
            try {
                const res = await fetch('/api/4g/unidades', { headers: { 'Accept': 'application/json' } });
                const ct = res.headers.get('content-type') || '';
                if (!ct.includes('application/json')) throw new Error('Resposta não é JSON');
                const body = await res.json();
                // aceita {success, data: [...]} ou array direto
                const arr = Array.isArray(body) ? body
                           : Array.isArray(body?.data) ? body.data
                           : [];
                if (arr.length === 0) throw new Error('Lista de unidades vazia');
                unidades = arr;
                atualizarSelect(unidades);
            } catch (e) {
                unidades = [];
                atualizarSelect(unidades);
                show(erroDiv, 'Erro ao carregar unidades: ' + (e.message || e));
            }
        }

        // filtro local
        pesquisa.addEventListener('input', () => {
            const termo = pesquisa.value.toLowerCase();
            const filtradas = unidades.filter(u => u.toLowerCase().includes(termo));
            atualizarSelect(filtradas);
        });

        // executar automação
        async function executar() {
            const unidade = unidadeSelect.value;
            hide(resultadoDiv, erroDiv);

            if (!unidade) {
                show(erroDiv, 'Selecione uma unidade.');
                return;
            }

            // desabilita botão enquanto roda
            executarBtn.disabled = true;
            const originalText = executarBtn.textContent;
            executarBtn.textContent = 'Automação rodando...';
            const failsafe = setTimeout(() => {
                executarBtn.disabled = false;
                executarBtn.textContent = originalText;
            }, 20000); // failsafe 20s

            try {
                const res = await fetch('/api/4g/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ unidade })
                });

                // tenta JSON, senão texto
                let body;
                const ct = res.headers.get('content-type') || '';
                try {
                    body = ct.includes('application/json') ? await res.json() : await res.text();
                } catch {
                    body = await res.text();
                }

                if (res.ok) {
                    if (typeof body === 'string') {
                        show(resultadoDiv, body); // backend devolveu texto direto
                    } else {
                        // { success, message?, data?, error? }
                        const msg = body.message || (body.data ? JSON.stringify(body.data, null, 2) : 'Operação concluída.');
                        show(resultadoDiv, msg);
                    }
                } else {
                    const msg = (typeof body === 'string') ? body : (body?.error || 'Erro desconhecido.');
                    show(erroDiv, msg);
                }
            } catch (e) {
                show(erroDiv, 'Erro ao conectar com o servidor: ' + (e.message || e));
            } finally {
                clearTimeout(failsafe);
                executarBtn.disabled = false;
                executarBtn.textContent = originalText;
            }
        }

        executarBtn.addEventListener('click', executar);
        carregarUnidades();
    </script>
  <script src="/js/sessionReminder.js"></script>
</body>
</html>
