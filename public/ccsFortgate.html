<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CCS-FortiGate</title>
<link rel="icon" type="image/png" href="https://i.imgur.com/8qVGalo.png">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  body {
    font-family: 'Inter', sans-serif;
    background-image: url('https://images.unsplash.com/photo-1749150270018-1dee5a5e4b88?q=80&w=1170&auto=format&fit=crop');
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center;
    background-attachment: fixed;
  }
  .content-box {
    background-color: rgba(30, 41, 59, 0.75);
    backdrop-filter: blur(4px);
    border-radius: 0.75rem;
    padding: 2rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    color: white;
    width: 90%;
    max-width: 900px;
    margin: 2rem auto;
  }
  input, select, button {
    background-color: #E5E7EB;
    color: #000;
    border-radius: 0.375rem;
    padding: 0.5rem 0.75rem;
    border: 1px solid #2672e4;
    width: 100%;
  }
  label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #9CA3AF;
  }
  button {
    background-color: #3B82F6;
    color: white;
    font-weight: 600;
  }
  button:hover {
    background-color: #2563EB;
  }
  pre {
    background-color: #1F2937;
    border: 1px solid #4B5563;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    color: #E5E7EB;
    min-height: 120px;
  }
  .grid-container {
    display: grid;
    grid-template-columns: repeat(1, 1fr);
    gap: 1.5rem;
  }
  @media (min-width: 768px) {
    .grid-container {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .help-fab {
    position: fixed; right: 24px; bottom: 24px;
    width: 44px; height: 44px; border-radius: 999px;
    border: 1px solid #3a3a3a; background:#1a1a1d; color:#eee;
    font-weight: 700; cursor: pointer;
    display:flex; align-items:center; justify-content:center;
    box-shadow: 0 6px 20px rgba(0,0,0,.35); z-index: 1000;
  }
  .help-fab:focus { outline: 2px solid #3a3a3a; outline-offset: 2px; }

  .help-bubble {
    position: fixed; right: 24px; bottom: 84px;
    max-width: 420px; padding: 14px 16px;
    border-radius: 14px; background:#101014; color:#eee;
    border:1px solid #2a2a2a; box-shadow: 0 14px 40px rgba(0,0,0,.5);
    z-index: 1000; display:none;
  }
  .help-bubble::after {
    content: ""; position:absolute; right: 18px; bottom:-10px;
    border-width:10px; border-style:solid;
    border-color:#101014 transparent transparent transparent;
    filter: drop-shadow(0 -2px 0 #2a2a2a);
  }
  .help-bubble h4 { margin: 0 0 8px 0; font-size: 16px; }
  .help-bubble p  { margin: 6px 0; color:#ccc; line-height:1.35; }
  .help-bubble code { background:#0b0b0c; border:1px solid #222; padding:2px 6px; border-radius:6px; }
  .help-bubble .close {
    position:absolute; top:8px; right:10px; border:0; background:transparent; color:#aaa; cursor:pointer;
    font-size:18px; line-height:1;
  }
  .help-bubble .close:hover { color:#fff; }


</style>
</head>

<body class="p-6">

<div class="content-box">

  <div class="flex justify-between items-start mb-6">
    <div>
      <h1 class="text-3xl font-bold">CCS - FortiGate – (Internet)</h1>
      <p class="text-gray-400">Geração de configuração baseada no modelo Internet.</p>
    </div>
    <a href="/tabela/ips" class="bg-gray-600 px-4 py-2 rounded hover:bg-gray-500">Tabela</a>
    <a href="javascript:history.back()" class="bg-gray-600 px-4 py-2 rounded hover:bg-gray-500">Voltar</a>
  </div>

  <form id="form">

    <div class="grid-container">
      <label>
        Singular CCS
        <input name="SINGULAR" required placeholder="CREDIMOGIANA">
      </label>

      <label>
        VRF
        <select name="VRF" id="vrf_select" required>
          <option value="internet">INTERNET</option>
          <option value="mpls">MPLS</option>
          <option value="mpls/24">MPLS/24</option>
        </select>
      </label>
 
      <label>
        PAC
        <input name="NUM_PA" required placeholder="09">
      </label>
      
      <label>
        IP da WAN
        <input name="WAN_IP" required placeholder="172.27.146.98">
      </label>

      <label id="ip_publico_label">
        IP de LAN
        <input name="IP_PUBLICO" id="ip_field" required placeholder="201.33.116.19/30">
      </label>
    </div>

    <div class="mt-6">
      <button type="submit" class="py-3 w-full">
        Baixar arquivo .conf
      </button>

      <h3 class="text-2xl font-semibold mt-8 mb-3">Preview das configurações</h3>
  <pre id="out">!Preview!</pre>
    </div>

      
  </form>

  
  


</div>

<button class="help-fab" id="helpFab" aria-controls="helpBubble" aria-expanded="false" title="Instrucoes">?</button>

  <div class="help-bubble" id="helpBubble" role="dialog" aria-labelledby="helpTitle" aria-modal="false">
    <button class="close" id="helpClose" aria-label="Fechar">×</button>
    <h4 id="helpTitle">Instrucoes rapidas</h4>
    <p>- Essa interface gera o arquivo de configuracoes padrao para FortiGate CCS.</p>
    <p>- Ao selecionar a <code>VRF</code> é alterado o ip <strong>público</strong> com o seu devido barramento.</p>
    <p>- Possivel visualiação com o campo de <strong>Preview</strong>.</p>
    <p>- Escolha a <code>VRF</code> de acordo com o caso: <strong>MPLS</strong> ou <strong>INTERNET</strong>.</p>
  </div>

<script type="module">
  const form = document.getElementById("form");
  const vrfSelect = document.getElementById("vrf_select");
  const pageTitle = document.querySelector("h1");
  const pageSubtitle = document.querySelector("p");
  const ipLabel = document.getElementById("ip_publico_label");
  const ipInput = document.getElementById("ip_field");

  vrfSelect.addEventListener("change", (e) => {
    const selectedVrf = e.target.value;
    
    // Atualiza o título e subtítulo
    pageTitle.textContent = `CCS - FortiGate – (${selectedVrf.toUpperCase()})`;
    pageSubtitle.textContent = `Configurações de ativação padrão CCS ${selectedVrf.toUpperCase()}.`;

    // Atualiza o label, placeholder e o NOME do campo de IP
    if (selectedVrf === "mpls/24") {
      ipLabel.childNodes[0].nodeValue = "IP de LAN ";
      ipInput.placeholder = "10.0.0.1/24";
      ipInput.name = "IP_PRIVADO"; // Atualiza o nome do input
    }
    else if (selectedVrf === "mpls") {
      ipLabel.childNodes[0].nodeValue = "IP de LAN ";
      ipInput.placeholder = "10.0.0.1/29";
      ipInput.name = "IP_PRIVADO"; // Atualiza o nome do input
    } else {
      ipLabel.childNodes[0].nodeValue = "IP de LAN ";
      ipInput.placeholder = "10.0.0.1/30";
      ipInput.name = "IP_PUBLICO"; // Retorna ao nome original
    }
  });

  const collectData = () =>
    Object.fromEntries(new FormData(form).entries());

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const out = document.getElementById("out");
    out.textContent = "Gerando configuração...";

    const response = await fetch("/api/ccsFortgate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: collectData() })
    });

    const payload = await response.json();

    if (!payload.ok) {
        out.textContent = `Erro:\n${payload.error || JSON.stringify(payload, null, 2)}`;
        return;
    }
    
    const content = payload.raw;
    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = payload.filename || "download.conf";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    out.textContent = `Arquivo ${a.download} gerado com sucesso.\n\n${content}`;
  });

  const helpFab    = document.getElementById("helpFab");
  const helpBubble = document.getElementById("helpBubble");
  const helpClose  = document.getElementById("helpClose");

  if (helpFab && helpBubble && helpClose) {
    const setBubble = (show) => {
      helpBubble.style.display = show ? "block" : "none";
      helpFab.setAttribute("aria-expanded", String(show));
    };

    helpFab.addEventListener("click", () => {
      const open = helpBubble.style.display !== "block";
      setBubble(open);
    });

    helpClose.addEventListener("click", () => setBubble(false));
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") setBubble(false);
    });
  }
</script>

  <script src="/js/sessionReminder.js"></script>
</body>
</html>
